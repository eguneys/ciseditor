!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var i in n)("object"==typeof exports?exports:t)[i]=n[i]}}(window,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){window,t.exports=function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){"use strict";n.r(e),n.d(e,"Paragraph",(function(){return i})),n.d(e,"Heading",(function(){return r})),n.d(e,"Ply",(function(){return o})),n.d(e,"Code",(function(){return s})),n.d(e,"Text",(function(){return l})),n.d(e,"parseCode",(function(){return a})),n.d(e,"parseParagraph",(function(){return u})),n.d(e,"parseParagraphFull",(function(){return c})),n.d(e,"parseMdFull",(function(){return h})),n.d(e,"parseMd",(function(){return f}));const i=1,r=2,o=3,s=1,l=2;function a(t){let e;if(e=(t=t.substring(1,t.length-1)).match(/^([a-zA-Z][^\s]*) ([a-zA-Z][^\s|^\/]*) (.*)/)){let[t,n,i,r]=e;return{variation:n,base:i,line:r}}if(e=t.match(/^([a-zA-Z][^\s]*) (.*)/)){let[t,n,i]=e;return{variation:n,line:i}}return{line:t}}function u(t){const e=/^</,n=/>$/;let i=l,r=[],o=[];return t.split(" ").forEach(t=>{let a;i===l?(a=t.match(e))?(o.push({type:l,content:r.join(" ")+" "}),i=s,r=[t],(a=t.match(n))&&(o.push({type:s,content:r.join(" ")}),i=l,r=[])):r.push(t):i===s&&((a=t.match(n))?(r.push(t),o.push({type:s,content:r.join(" ")}),i=l,r=[]):r.push(t))}),r.length>0&&o.push({type:i,content:r.join(" ")}),o}function c(t){return u(t).map(t=>(t.type===s&&(t.content=a(t.content)),t))}function h(t){return f(t).map(t=>(t.type===i&&(t.content=c(t.content)),t))}function f(t){const e=/^#([^\n]*)/,n=/^=([^\n]*)/;let s=[],l=[],a=t.split("\n"),u=0;if(a.forEach(t=>{if(""===t){if(s.length){let t=s.join("\n");l.push({type:i,pos:u,content:t}),s=[],u+=t.length+1}return void(u+=1)}let a;if(a=t.match(n)){let t=s.join("\n");s.length&&(l.push({type:i,pos:u,content:t}),s=[],u+=t.length+1),t=a[1],l.push({type:o,pos:u,content:t}),u+=t.length+2}else if(a=t.match(e)){let t=s.join("\n");s.length&&(l.push({type:i,pos:u,content:t}),s=[],u+=t.length+1),t=a[1],l.push({type:r,pos:u,content:t}),u+=t.length+2}else s.push(t)}),s.length){let t=s.join("\n");l.push({type:i,pos:u,content:t}),s=[],u+=t.length}return l}},function(t,e,n){t.exports=n(2)},function(t,e,n){n(3),n(4),n(5),n(6);const i=n(7);t.exports=i.app,t.exports.md=n(0),t.exports.version="1.0.2"},function(t,e,n){},function(t,e,n){},function(t,e,n){},function(t,e,n){},function(t,e,n){"use strict";n.r(e),n.d(e,"app",(function(){return Wt}));var i={};n.r(i),n.d(i,"files",(function(){return M})),n.d(i,"ranks",(function(){return j})),n.d(i,"allKeys",(function(){return A})),n.d(i,"pos2key",(function(){return B})),n.d(i,"key2pos",(function(){return R})),n.d(i,"black",(function(){return T})),n.d(i,"white",(function(){return K})),n.d(i,"asWhite",(function(){return L})),n.d(i,"flip",(function(){return F})),n.d(i,"readShapes",(function(){return I})),n.d(i,"isFen",(function(){return N})),n.d(i,"readFen",(function(){return V})),n.d(i,"readMoves",(function(){return W})),n.d(i,"readPly",(function(){return D})),n.d(i,"writeFen",(function(){return q})),n.d(i,"fPosToTranslateAbs",(function(){return H}));var r={};n.r(r),n.d(r,"tag",(function(){return tt})),n.d(r,"div",(function(){return et})),n.d(r,"textNode",(function(){return nt})),n.d(r,"updateChildren",(function(){return it})),n.d(r,"fTranslateAbs",(function(){return rt})),n.d(r,"fAddClass",(function(){return ot})),n.d(r,"fAttribute",(function(){return st})),n.d(r,"fListen",(function(){return lt})),n.d(r,"fHide",(function(){return at})),n.d(r,"fShow",(function(){return ut}));var o={};function s(t,e){return t?l(t):a(e)}function l(t){return new u(null,t)}function a(t){return new u(t)}function u(t,e){this.invalid=t,this.valid=e;const n=n=>{e=null,t=n,this.invalid=t,this.valid=e},i=n=>{e=n,t=null,this.valid=e,this.invalid=t};this.flatMap=(t,e=(t=>validation.invalid(t)))=>this.valid?t(this.valid):e(this.invalid),this.fold=(t,e=(t=>t))=>this.valid?t(this.valid):e(this.invalid),this.rawMap=t=>(this.valid&&i(t(e)),this),this.map=t=>this.copy().rawMap(t),this.check=(t,e)=>(this.valid&&t(this.valid)&&n(e),this),this.checkOr=(t,e,i)=>(!this.valid||t(this.valid)||e(this.valid)||n(i),this),this.getOrElse=t=>this.valid?this.valid:t(),this.copy=()=>new u(t,e),this.copyMap=t=>this.copy().map(t)}function c(t){let e={};for(let n in t)e[n]=t[n];return e}function h(t,e){let n={};return Object.keys(t).forEach(i=>{let r=e(i,t[i]),o=Object.keys(r)[0];n[o]=r[o]}),n}function f(t,e){Object.keys(t).forEach(n=>e(n,t[n]))}n.r(o),n.d(o,"svg",(function(){return ft})),n.d(o,"renderShape",(function(){return dt})),n.d(o,"renderMarker",(function(){return mt}));var d=n(0);function p(t){this.index=t,this.char=String.fromCharCode(97+t)}function y(t){this.index=t,this.char=String.fromCharCode(49+t)}const w={A:new p(0),B:new p(1),C:new p(2),D:new p(3),E:new p(4),F:new p(5),G:new p(6),H:new p(7),of:t=>new p(7&t.index)};function m(t){this.index=t;let e=w.of(this),n=(t=>new y(t.index>>3))(this);this.file=e,this.rank=n,this.key=e.char+n.char,this.hore=(t,e)=>{let n=e(this);return n?[n,...t(n)?[]:n.hore(t,e)]:[]},this.righte=t=>this.hore(t,t=>t.right()),this.lefte=t=>this.hore(t,t=>t.left()),this.down=()=>v.at(e.index,n.index-1),this.left=()=>v.at(e.index-1,n.index),this.downLeft=()=>v.at(e.index-1,n.index-1),this.downRight=()=>v.at(e.index+1,n.index-1),this.up=()=>v.at(e.index,n.index+1),this.right=()=>v.at(e.index+1,n.index),this.upLeft=()=>v.at(e.index-1,n.index+1),this.upRight=()=>v.at(e.index+1,n.index+1)}const v={apply:t=>new m(t),atfr:(t,e)=>new m(t.index+8*e.index),at:(t,e)=>0<=t&&t<8&&0<=e&&e<8?new m(t+8*e):null},g=[];for(let t=0;t<64;t++)g.push(t);v.all=g.map(t=>new m(t)),v.allKeys={},v.all.forEach(t=>v.allKeys[t.key]=t),v.fromKey=t=>v.allKeys[t],v.A1=new m(0),v.B1=new m(1),v.C1=new m(2);const b={forsyth:"P",roleString:"pawn"},k={forsyth:"N",roleString:"knight",dirs:[t=>v.at(t.file.index-1,t.rank.index+2),t=>v.at(t.file.index-1,t.rank.index-2),t=>v.at(t.file.index+1,t.rank.index+2),t=>v.at(t.file.index+1,t.rank.index-2),t=>v.at(t.file.index-2,t.rank.index+1),t=>v.at(t.file.index-2,t.rank.index-1),t=>v.at(t.file.index+2,t.rank.index+1),t=>v.at(t.file.index+2,t.rank.index-1)]},x={forsyth:"B",roleString:"bishop",dirs:[t=>t.upLeft(),t=>t.upRight(),t=>t.downLeft(),t=>t.downRight()]},P={color:t=>({role:"rook",color:t}),forsyth:"R",roleString:"rook",dirs:[t=>t.up(),t=>t.down(),t=>t.left(),t=>t.right()]},E={forsyth:"Q",roleString:"queen",dirs:[P.dirs,x.dirs].flat()},S={color:t=>({role:"king",color:t}),forsyth:"K",roleString:"king",dirs:E.dirs},C={all:[S,E,x,P,b,k],allByRole:{}};C.all.forEach(t=>C.allByRole[t.roleString]=t),C.allByForsyth={},C.all.forEach(t=>C.allByForsyth[t.forsyth]=t),C.forsyth=t=>C.allByForsyth[t];const O={key:"g",color:"#15781B",opacity:1,lineWidth:10},M=["a","b","c","d","e","f","g","h"],j=["1","2","3","4","5","6","7","8"],A=Array.prototype.concat(...M.map(t=>j.map(e=>t+e))),B=t=>A[8*t[0]+t[1]],R=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],T="black",K="white";function L(t){return t===K}function F(t){return t===K?T:K}let $={w:K,b:T},_={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"};function I(t){return t?t.split(" ").map(t=>{let[e,n]=t.split("-");return{orig:e,dest:n,brush:O}}):[]}function N(t){return t.includes("/")}function V(t){let[e,n,i,r]=t.split(" "),o=$[n],s={};return e.split("/").forEach((t,e)=>{e=7-e;let n=0;for(let i of t){let t,r;(t=_[i])?r=T:(t=_[i.toLowerCase()])&&(r=K),r?(s[B([n,e])]={role:t,color:r},n++):n+=parseInt(i)}}),{pieces:s,color:o}}function W(t){const e=/^(\d*)\.\.\.$/,n=/^(\d*)\.$/;let i,r,o=[];return t.split(" ").forEach(t=>{let s;(s=t.match(e))?(r=2*parseInt(s[0]),i=[null]):(s=t.match(n))?(r=2*parseInt(s[0])-1,i=[]):(s=moveMatch(t))&&(i.push({ply:r,...s}),r++,2===i.length&&(o.push(i),i=[]))}),1===i.length&&o.push(i),{moves:o}}function D(t){return parseInt(t)}function q({pieces:t}){let e="";for(let n=7;n>=0;n--){let i=0;for(let r=0;r<=7;r++){let o;if(o=t[B([r,n])]){i>0&&(e+=i,i=0);let t=C.allByRole[o.role];e+=o.color===K?t.forsyth.toUpperCase():t.forsyth.toLowerCase()}else i++}i>0&&(e+=i),e+="/"}return e}const H=t=>{const e=t.width/8,n=t.height/8;return(t,i)=>((t,e,n,i)=>[(e?t[0]:7-t[0])*n,(e?7-t[1]:t[1])*i])(t,i,e,n)},Q={name:"king",castledKingFile:w.G,castledRookFile:w.F,tripToRook:(t,e)=>t.righte(t=>e.pieces[t.key])},z={name:"queen",castledKingFile:w.C,castledRookFile:w.D,tripToRook:(t,e)=>t.lefte(t=>e.pieces[t.key])};function U(t,e){this.board=t,this.color=e,t.actorsOf(e)}function Z({piece:t,orig:e,dest:n,situationBefore:i,after:r,capture:o,promotion:s,castle:l,enpassant:a}){this.piece=t,this.orig=e,this.dest=n,this.situationBefore=()=>i,this.after=()=>r,this.before=()=>i.board,this.situationAfter=()=>new U(r,F(t.color))}function G(t,e,n){let i=t.color;this.color=i,this.pos=e,this.pseudoValidMoves=function(){let o=[];switch(t.role){case"pawn":let t=l()(e),f=!n.pieces[t.key]&&t;function h(r){let o=r(t);return o&&n.pieces[o.key]&&n.pieces[o.key].color!==i?c(o,n.taking(e,o),{capture:o}):null}let d=f&&l()(f),p=[];d&&(p=c(d,n.move(e,d))),o.push([f&&s(f)||[],p,h(t=>t.left())||[],h(t=>t.right())||[]].flat());break;case"king":o.push(a(S.dirs)),e.right()&&e.left()&&o.push(r());break;case"knight":o.push(a(k.dirs));break;case"bishop":o.push(u(x.dirs));break;case"rook":o.push(u(P.dirs));break;case"queen":o.push(u(E.dirs))}return o.flatMap(t=>t)};const r=()=>o(Q).concat(o(z));function o(t){let e=n.kingPosOf(i);if(!e)return[];let r=t.tripToRook(e,n),o=r[r.length-1],s=v.atfr(t.castledKingFile,e.rank),l=v.atfr(t.castledRookFile,o.rank),a={king:{[e.key]:s},rook:{[o.key]:l},side:t.name};return[c(e,n.take(e).take(o).place(S.color(i),s).place(P.color(i),l),{castle:a})]}function s(t){let i=n.move(e,t);return i?c(t,i):null}function l(){return function(t){return"white"===t?t=>t.up():t=>t.down()}(t.color)}function a(t){return t.flatMap(t=>t(e)||[]).flatMap(t=>{let i=n.move(e,t);return i?[c(t,i)]:[]})}function u(t){let r=[];return t.forEach(t=>function t(o,s){let l;if(l=s(o)){let o=n.pieces[l.key];if(o){if(o.color!==i){let t=n.taking(e,l);r.push(c(l,t,{capture:l}))}}else{let i=n.move(e,l);i&&r.push(c(l,i)),t(l,s)}}}(e,t)),r}function c(i,r,o){let s,l,a,u;return o&&(s=o.capture,a=o.castle,l=o.promotion,u=o.enpassant),new Z({piece:t,orig:e,dest:i,situationBefore:new U(n,t.color),after:r,capture:s,castle:a,promotion:l,enpassant:u})}this.castleOn=o}function X(t,e){this.take=n=>{let i=c(t);return delete i[n.key],new X(i,e)},this.place=(n,i)=>{let r=c(t);return r[i.key]=n,new X(r,e)},this.move=(n,i)=>{let r=c(t);return r[i.key]=r[n.key],delete r[n.key],new X(r,e)},this.taking=(n,i)=>{let r=c(t);return r[i.key]=r[n.key],delete r[n.key],new X(r,e)},this.actorsOf=()=>{let[t,e]=function(t,e){let n=[],i=[];return t.forEach(t=>(t=>"white"===t.color)(t)?n.push(t):i.push(t)),[n,i]}(Object.values(this.actors));return{white:t,black:e}},this.kingPosOf=e=>{let n=Object.keys(t).find(n=>{let i=t[n];return i.color===e&&"king"===i.role});return v.fromKey(n)},this.actorAt=t=>this.actors[t],this.color=e,this.pieces=t,this.actors=h(t,(t,e)=>({[t]:new G(e,v.fromKey(t),this)}))}function Y(t,e,n,i,r,o,s){function u(t,e){return!t||t===e}this.san=s,this.dest=t,this.role=e,this.capture=n,this.file=i,this.rank=r,this.promotion=o,this.move=n=>{let o=null;return f(n.board.pieces,(s,l)=>{if(!o&&l.color===n.color&&l.role===e.roleString&&u(i,v.fromKey(s).file.char)&&u(r,v.fromKey(s).rank.char)){let e=new G(l,v.fromKey(s),n.board);o=e.pseudoValidMoves().find(e=>e.dest.key===t.key)}}),o?l(o):a("No move found: "+s)}}function J(t,e){this.san=e,this.side=t,this.move=e=>s(e.board.kingPosOf(e.color),"No king found").flatMap(n=>s(e.board.actorAt(n.key),"No Actor found").flatMap(e=>s(e.castleOn(t)[0],"Cannot castle")))}function tt(t,e=[],n){let[i,...r]=t.split("."),o=document.createElement(i);return r.forEach(t=>{o.classList.add(t)}),e.forEach?e.forEach(t=>{o.appendChild(t)}):o.append(e),n&&(n.forEach?n.forEach(t=>t(o)):n(o)),o}U.apply=(t=X.initial())=>new U(t,t.color),X.initial=()=>X.fromFen("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"),X.fromFen=t=>{let{pieces:e,color:n}=V(t);return new X(e,n)};const et=(t,e,n)=>tt("div"+t,e,n),nt=t=>document.createTextNode(t),it=(t,e)=>{for(t=t.firstChild;t;)e(t),t=t.nextSibling},rt=t=>e=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},ot=t=>e=>{t.split(".").forEach(t=>{e.classList.add(t)})},st=t=>e=>(Object.keys(t).forEach(n=>{t[n]&&e.setAttribute(n,t[n])}),e),lt=(t,e)=>n=>{n.addEventListener(t,()=>{e(n)})},at=t=>{t.classList.contains("hidden")||t.classList.add("hidden")},ut=t=>{t.classList.contains("hidden")&&t.classList.remove("hidden")};function ct(t,e){return new ht(t,e)}function ht(t,e){t.fold(({ply:t,move:n})=>{this.ply=t,this.san=n.san,this.plyStrWhite=(t+1)/2+". ",this.plyStrBlack=t/2+"... ",e(t).fold(t=>t,t=>{this.err=t})},({err:t,san:e})=>{this.ply="E",this.plyStrWhite="E. ",this.plyStrBlack="E. ",this.err=t,this.san=e})}function ft(t,e=[]){let n=document.createElementNS("http://www.w3.org/2000/svg",t);return e.forEach&&e.forEach(t=>n.appendChild(t)),n}function dt(t,e,n){let i,r=wt(R(t.orig),e);if(t.dest){let o=wt(R(t.dest),e);i=function(t,e,n,i){const r=function(t){return 10/512*t.width}(i),o=yt(e,i),s=yt(n,i),l=s[0]-o[0],a=s[1]-o[1],u=Math.atan2(a,l),c=Math.cos(u)*r,h=Math.sin(u)*r;return vt(ft("line"),{stroke:t.color,"stroke-width":pt(t,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+t.key+")",opacity:t.opacity,x1:o[0],y1:o[1],x2:s[0]-c,y2:s[1]-h})}(t.brush,r,o,n)}else i=function(t,e,n){const i=yt(e,n),r=function(t){return t.width/512*4}(n),o=(n.width+n.height)/32;return vt(ft("circle"),{stroke:t.color,"stroke-width":r,fill:"none",opacity:t.opacity,cx:i[0],cy:i[1],r:o-r/2})}(t.brush,r,n);return i}function pt(t,e){return(t.lineWidth||10)/512*e.width}function yt(t,e){return[(t[0]+.5)*e.width/8,(7.5-t[1])*e.height/8]}function wt(t,e){return"white"===e?t:[7-t[0],7-t[1]]}function mt(t){const e=vt(ft("marker"),{id:"arrowhead-"+t.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return e.appendChild(vt(ft("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("mdKey",t.key),e}function vt(t,e){for(const n in e)t.setAttribute(n,e[n]);return t}let{ranks:gt,files:bt,key2pos:kt,fPosToTranslateAbs:xt}=i,{svg:Pt,renderMarker:Et,renderShape:St}=o,{div:Ct,tag:Ot,fAttribute:Mt,fTranslateAbs:jt,fListen:At,updateChildren:Bt}=r;function Rt(t,e){let{variation:n,line:i,board:r}=e,o=(e,i)=>{t.show(n,e,i)},s=()=>{t.hide()};const l=e=>t.vMove(n,e);this.wrap=()=>{let e=[],a=t.lineDepth(n),u=ot("depth"+a);r||(e=function(t,e,n){let i=t=>i=>{["touchstart","mouseover"].forEach(n=>At(n,n=>e(t,n))(i)),["touchend","mouseout"].forEach(t=>At(t,n)(i))};return t.flatMap(([t,e])=>{let n=t&&i(t.ply),r=e&&i(e.ply),o=t&&Mt({title:t.err,"data-err":t.err}),s=e&&Mt({title:e.err,"data-err":e.err});return t&&e?[Ot("strong.moven",t.plyStrWhite),Ot("span.movem",t.san+" ",[o,n]),Ot("span.movem",e.san+" ",[s,r])]:t?[Ot("strong.moven",t.plyStrWhite),Ot("span.movem",t.san+" ",[o,n])]:[Ot("strong.moven",e.plyStrBlack),Ot("span.movem",e.san+" ",[s,r])]})}(i.map(([t,e])=>[t&&ct(t,l),e&&ct(e,l)]),o,s));let c=tt("span.line",e);return u(c),c},this.render=()=>{}}function Tt(t,e){this.wrap=()=>nt(e),this.render=()=>{}}function Kt(t,e){let n=[];e.forEach(e=>{let i;switch(e.type){case d.Code:i=new Rt(t,e.content);break;case d.Text:i=new Tt(t,e.content)}n.push(i)}),this.wrap=()=>tt("p",n.map(t=>t.wrap())),this.render=()=>{}}function Lt(t,e){this.wrap=()=>tt("h2",e),this.render=()=>{}}function Ft(t,e){let n,i,r,o,s,l={},a=I();this.bounds=()=>n,this.init=(e,n)=>{if(i=[],0===n){let n=t.plyInitial(e);l=n.board.pieces}else t.vMove(e,n).fold(t=>{let e=t.situationAfter();l=e.board.pieces,i.push(t.orig.key),i.push(t.dest.key)},t=>{r=t})},this.syncVisible=()=>{e&&(n=e.getBoundingClientRect(),this.isInViewport=function(t){return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}(n))},this.wrap=()=>e=e||tt("div.ply"),this.render=()=>{o&&(o(),e.removeChild(s.wrapper)),n=e.getBoundingClientRect(),s=function(t,e,n,i,r){let o=L(t),s=xt(i),l=Ot("md-board",[...r.map(t=>{let e=kt(t),n=Ot("square.last-move",[],jt(s(e,o)));return n.mdKey=t,n}),...Object.keys(e).map(t=>{let n=kt(t),i=e[t],r=Ot(`piece.${i.color}.${i.role}`,[],jt(s(n,o)));return r.mdKey=t,r})]),a=Pt("svg",[Pt("defs",[Et(O)]),...n.map(e=>St(e,t,i))]);return{wrapper:Ot("md-wrap",[l,a,Ot("coords.ranks."+t,gt.map(t=>Ot("coord",t))),Ot("coords.files."+t,bt.map(t=>Ot("coord",t)))]),board:l,svg:a}}("white",l,a,n,i),e.appendChild(s.wrapper),o=function(t,e){const n=new window.ResizeObserver(()=>{!function(t,e){let n=e.getBoundingClientRect(),i=xt(n);Bt(e,e=>{jt(i(kt(e.mdKey),t))(e)})}(L("white"),s.board)});return n.observe(t),()=>{n.unobserve(t)}}(e)}}function $t(t,e){let n=[];e.forEach(({type:e,content:i})=>{let r;switch(e){case d.Paragraph:r=new Kt(t,i);break;case d.Heading:r=new Lt(t,i);break;case d.Ply:r=new Ft(t);let[e,n]=i.split(" ");n=parseInt(n),r.init(e,n)}n.push(r)}),this.visiblePly=()=>n.filter(t=>t instanceof Ft&&t.isInViewport)[0],this.findVisiblePly=()=>{n.filter(t=>t instanceof Ft).forEach(t=>t.syncVisible())},this.listen=()=>{!function(t){let e;document.addEventListener("scroll",(function(n){clearTimeout(e),e=setTimeout(t,60)}),!1)}(this.findVisiblePly),this.findVisiblePly()},this.wrap=()=>tt("div",n.map(t=>t.wrap())),this.render=()=>{n.forEach(t=>t.render())}}function _t(t){let e,n,i;this.init=(t,r,o)=>{e=t,n=r,i=o,this.initialPlyAsSituation=e?U.apply(e):null,this.line=n,this.base=i,this.basePly=n[0]?n[0].ply-1:0,this.moves=[],this.plies=[],this.elies=[],this.playedOut=!1},this.ply=t=>this.plies[t],this.move=t=>this.moves[t],this.ely=t=>this.elies[t],this.play=()=>{this.playedOut||(this.initialPlyAsSituation&&(this.plies[this.basePly]=this.initialPlyAsSituation),n.length>0&&(this.initialPlyAsSituation||(this.initialPlyAsSituation=t.ply(this.base,this.basePly),this.plies[this.basePly]=this.initialPlyAsSituation),n.forEach(({ply:t,move:e})=>{let n=this.ply(t-1);n?e.move(n).fold(e=>{this.plies[t]=e.situationAfter(),this.moves[t]=e},e=>{this.elies[t]=e}):this.elies[t]="No Situation found"})),this.playedOut=!0)}}function It(){let t,e,n=[];this.define=(n,i)=>{t=n,e=i},this.addLine=t=>{n.push(t)},this.build=i=>{n=n.flatMap(t=>t.flat().flatMap(t=>t?t.copyMap(t=>[t]).getOrElse(t=>[]):[])).sort((t,e)=>t-e);let r=new _t(i);return r.init(t,n,e),r}}function Nt(t){let e,n={};this.playUptoBase=t=>{t.base&&this.playUptoBase(n[t.base]),t.play()},this.lineDepth=(t,e=0)=>n[t].base?1+this.lineDepth(n[t].base):e,this.initialPly=t=>n[t].initialPlyAsSituation,this.ply=(t,e)=>n[t].ply(e),this.move=(t,e)=>n[t].move(e),this.err=(t,e)=>n[t].ely(e),this.init=t=>{e=function(t){return t.filter(t=>t.type===d.Paragraph).flatMap(t=>t.content).filter(t=>t.type===d.Code).map(t=>t.content)}(t),e.forEach(t=>{let{variation:e,base:i,line:r,board:o}=t;if(o){let t=new It;return t.define(o),void(n[e]=t)}if(n[e])return void n[e].addLine(r);let s=new It;n[e]=s,s.define(null,i),s.addLine(r)}),n=h(n,(t,e)=>({[t]:e.build(this)})),f(n,(t,e)=>{this.playUptoBase(e)})}}function Vt(t){let e,n=new Nt(this);this.games=n;let i=d.parseMdFull(t);!function(t){t.forEach(t=>{switch(t.type){case d.Paragraph:t.content.forEach(t=>{switch(t.type){case d.Code:N(t.content.line)?t.content.board=X.fromFen(t.content.line):t.content.line=function(t){const e=/^(\d*)\.\.\.$/,n=/^(\d*)\.$/;let i,r,o=[];return t.split(" ").forEach(t=>{let s;if(s=t.match(e))r=2*parseInt(s[0]),i=[null];else if(s=t.match(n))r=2*parseInt(s[0])-1,i=[];else{if(!i)return;let e=function(t){if("O-O"===t||"o-o"===t||"0-0"===t)return l(new J(Q,t));if("O-O-O"===t||"o-o-o"===t||"0-0-0"===t)return l(new J(z,t));let e=t.match(/^(N|B|R|Q|K|)([a-h]?)([1-8]?)(x?)([a-h][1-8])(=?[NBQR]?)(\+?)(\#?)$/);if(!e)return a({err:"Couldn't parse",san:t});let[n,i,r,o,s,u,c,h,f]=e,d=v.fromKey(u);return u?l(new Y(d,C.forsyth(i)||b,""!==s,r,o,c,t)):a({err:"Invalid move",san:t})}(t).map(t=>({ply:r++,move:t}));i.push(e),2===i.length&&(o.push(i),i=[])}}),i&&1===i.length&&o.push(i),o}(t.content.line);break;case d.Text:}return t});break;case d.Heading:case d.Ply:}return t})}(i),n.init(i),this.lineDepth=n.lineDepth,this.vMove=(t,e)=>{let i=n.err(t,e),r=n.move(t,e);return i?a(i):l(r)},this.plyInitial=t=>n.initialPly(t);let r=new $t(this,i);r.listen();let o=this.visiblePly=r.visiblePly,s=et(".hover-ply",[],at),u=new Ft(this,s);this.hide=()=>{at(s)},this.show=(t,n,i)=>{let r=o(),l=[window.pageXOffset,window.pageYOffset];if(r)l[0]+=r.bounds().left,l[1]+=r.bounds().top;else{let{clientWidth:t}=e,n=i.getBoundingClientRect(),r=s.getBoundingClientRect();n.left<t/2&&(l[0]+=t-r.width-4)}rt(l)(s),u.init(t,n),u.render(),ut(s)},this.wrap=()=>(e=r.wrap(),e.appendChild(s),e),this.render=()=>{r.render()}}function Wt(t,e){let n=new Vt(e.md),i=n.wrap();t.appendChild(i),n.render()}}])},function(t,e,n){t.exports=n(2)},function(t,e,n){n(3);const i=n(4);t.exports=i.app,t.exports.version="2.0.2"},function(t,e,n){},function(t,e,n){"use strict";n.r(e),n.d(e,"app",(function(){return l}));var i=function(t,e){let n,i=0;return function(...r){let o=Date.now()-i;function s(){n=void 0,i=Date.now(),e(...r)}n&&clearTimeout(n),o>t?s():n=setTimeout(s,t-o)}};function r(t,e=[],n){let[i,...r]=t.split("."),o=document.createElement(i);return r.forEach(t=>{o.classList.add(t)}),e.forEach?e.forEach(t=>{o.appendChild(t)}):o.append(e),n&&n(o),o}var o=n(0),s=n.n(o);function l(t,e={}){let{input:n,content:o=""}=e;n||(n=()=>{});let l={},{$wrapper:a,$editor:u,$preview:c}=function({input:t,caret:e}){var n,i,o;let s=r("ch-editor",[r("textarea",[],(n=[(i="input",o=(n,i)=>{e(i.target.selectionStart),t(n.value)},t=>{t.addEventListener(i,e=>{o(t,e)})})],(...t)=>{n.forEach(e=>e(...t))}))]),l=r("ch-preview");return{$wrapper:r("ch-wrap",[s,l]),$editor:s,$preview:l}}({content:o,caret:t=>{let e;for(let n in l){let i=l[n];if(!(i.pos<t))break;e=i}e&&function(t,e){let n=t.getBoundingClientRect();t.scrollTop=e.offsetTop-.3*n.width}(c,e.$_)},input:i(2e3,t=>{n(t);let e=[],i=c.firstChild;for(;i;)e.push(i),i=i.nextSibling;for(let t of e)c.removeChild(t);s()(c,{md:t})})});u.firstChild.value=o,s()(c,{md:u.firstChild.value}),t.appendChild(a)}}])}));